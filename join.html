<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Joining road crash tables | Reproducible road safety research with R: A practical introduction</title>
  <meta name="description" content="A reproducible and open source approach to applied road safety research" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Joining road crash tables | Reproducible road safety research with R: A practical introduction" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ITSLeeds.github.io/rrsrr/" />
  
  <meta property="og:description" content="A reproducible and open source approach to applied road safety research" />
  <meta name="github-repo" content="ITSLeeds/rrsrr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Joining road crash tables | Reproducible road safety research with R: A practical introduction" />
  
  <meta name="twitter:description" content="A reproducible and open source approach to applied road safety research" />
  

<meta name="author" content="Robin Lovelace" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="space.html"/>
<link rel="next" href="next-steps.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preamble</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i>About the Author</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#disclaimer"><i class="fa fa-check"></i>Disclaimer</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#foreword-road-safety-gb"><i class="fa fa-check"></i>Foreword: Road Safety GB</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#forword-department-for-transport"><i class="fa fa-check"></i>Forword: Department for Transport</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#forword-rac-foundation"><i class="fa fa-check"></i>Forword: RAC Foundation</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#preface"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#thanks"><i class="fa fa-check"></i>Thanks</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#reproducibility"><i class="fa fa-check"></i><b>1.1</b> Reproducibility</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-is-r"><i class="fa fa-check"></i><b>1.2</b> What is R?</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#why-r-for-road-safety-research"><i class="fa fa-check"></i><b>1.3</b> Why R for road safety research?</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>1.4</b> Prerequisites</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#installing-r-and-rstudio"><i class="fa fa-check"></i><b>1.5</b> Installing R and RStudio</a></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#r-in-the-cloud"><i class="fa fa-check"></i><b>1.6</b> R in the cloud</a></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#install-pkgs"><i class="fa fa-check"></i><b>1.7</b> Recommended packages</a></li>
<li class="chapter" data-level="1.8" data-path="introduction.html"><a href="introduction.html#overview"><i class="fa fa-check"></i><b>1.8</b> Overview</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> R basics</a><ul>
<li class="chapter" data-level="2.1" data-path="basics.html"><a href="basics.html#creating-and-removing-r-objects"><i class="fa fa-check"></i><b>2.1</b> Creating and removing R objects</a></li>
<li class="chapter" data-level="2.2" data-path="basics.html"><a href="basics.html#object-types-vectors-and-data-frames"><i class="fa fa-check"></i><b>2.2</b> Object types: vectors and data frames</a></li>
<li class="chapter" data-level="2.3" data-path="basics.html"><a href="basics.html#subsetting-by-index-or-column-name"><i class="fa fa-check"></i><b>2.3</b> Subsetting by index or column name</a></li>
<li class="chapter" data-level="2.4" data-path="basics.html"><a href="basics.html#subsetting-by-values"><i class="fa fa-check"></i><b>2.4</b> Subsetting by values</a></li>
<li class="chapter" data-level="2.5" data-path="basics.html"><a href="basics.html#dealing-with-nas-and-recoding"><i class="fa fa-check"></i><b>2.5</b> Dealing with NAs and recoding</a></li>
<li class="chapter" data-level="2.6" data-path="basics.html"><a href="basics.html#changing-class"><i class="fa fa-check"></i><b>2.6</b> Changing class</a></li>
<li class="chapter" data-level="2.7" data-path="basics.html"><a href="basics.html#recoding-values"><i class="fa fa-check"></i><b>2.7</b> Recoding values</a></li>
<li class="chapter" data-level="2.8" data-path="basics.html"><a href="basics.html#saving-r-objects"><i class="fa fa-check"></i><b>2.8</b> Saving R objects</a></li>
<li class="chapter" data-level="2.9" data-path="basics.html"><a href="basics.html#now-you-are-ready-to-use-rstudio"><i class="fa fa-check"></i><b>2.9</b> Now you are ready to use RStudio</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="rstudio.html"><a href="rstudio.html"><i class="fa fa-check"></i><b>3</b> Using RStudio</a><ul>
<li class="chapter" data-level="3.1" data-path="rstudio.html"><a href="rstudio.html#projects-and-scripts"><i class="fa fa-check"></i><b>3.1</b> Projects and scripts</a></li>
<li class="chapter" data-level="3.2" data-path="rstudio.html"><a href="rstudio.html#writing-and-running-code"><i class="fa fa-check"></i><b>3.2</b> Writing and running code</a></li>
<li class="chapter" data-level="3.3" data-path="rstudio.html"><a href="rstudio.html#viewing-objects"><i class="fa fa-check"></i><b>3.3</b> Viewing Objects</a></li>
<li class="chapter" data-level="3.4" data-path="rstudio.html"><a href="rstudio.html#autocompletion"><i class="fa fa-check"></i><b>3.4</b> Autocompletion</a></li>
<li class="chapter" data-level="3.5" data-path="rstudio.html"><a href="rstudio.html#getting-help"><i class="fa fa-check"></i><b>3.5</b> Getting help</a></li>
<li class="chapter" data-level="3.6" data-path="rstudio.html"><a href="rstudio.html#commenting-code"><i class="fa fa-check"></i><b>3.6</b> Commenting Code</a></li>
<li class="chapter" data-level="3.7" data-path="rstudio.html"><a href="rstudio.html#the-global-environment"><i class="fa fa-check"></i><b>3.7</b> The global environment</a></li>
<li class="chapter" data-level="3.8" data-path="rstudio.html"><a href="rstudio.html#debugging-code"><i class="fa fa-check"></i><b>3.8</b> Debugging Code</a></li>
<li class="chapter" data-level="3.9" data-path="rstudio.html"><a href="rstudio.html#productivity-boosting-features"><i class="fa fa-check"></i><b>3.9</b> Productivity boosting features</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pkgs.html"><a href="pkgs.html"><i class="fa fa-check"></i><b>4</b> R packages</a><ul>
<li class="chapter" data-level="4.1" data-path="pkgs.html"><a href="pkgs.html#what-are-packages"><i class="fa fa-check"></i><b>4.1</b> What are packages?</a></li>
<li class="chapter" data-level="4.2" data-path="pkgs.html"><a href="pkgs.html#the-stats19-r-package"><i class="fa fa-check"></i><b>4.2</b> The stats19 R package</a></li>
<li class="chapter" data-level="4.3" data-path="pkgs.html"><a href="pkgs.html#installing-packages"><i class="fa fa-check"></i><b>4.3</b> Installing packages</a></li>
<li class="chapter" data-level="4.4" data-path="pkgs.html"><a href="pkgs.html#loading-packages"><i class="fa fa-check"></i><b>4.4</b> Loading packages</a></li>
<li class="chapter" data-level="4.5" data-path="pkgs.html"><a href="pkgs.html#using-packages"><i class="fa fa-check"></i><b>4.5</b> Using packages</a></li>
<li class="chapter" data-level="4.6" data-path="pkgs.html"><a href="pkgs.html#updating-packages"><i class="fa fa-check"></i><b>4.6</b> Updating packages</a></li>
<li class="chapter" data-level="4.7" data-path="pkgs.html"><a href="pkgs.html#ggplot2"><i class="fa fa-check"></i><b>4.7</b> ggplot2</a></li>
<li class="chapter" data-level="4.8" data-path="pkgs.html"><a href="pkgs.html#dplyr"><i class="fa fa-check"></i><b>4.8</b> dplyr</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>5</b> Manipulating data</a><ul>
<li class="chapter" data-level="5.1" data-path="data.html"><a href="data.html#tibbles"><i class="fa fa-check"></i><b>5.1</b> tibbles</a></li>
<li class="chapter" data-level="5.2" data-path="data.html"><a href="data.html#filter-and-select-rows-and-columns"><i class="fa fa-check"></i><b>5.2</b> filter() and select() rows and columns</a></li>
<li class="chapter" data-level="5.3" data-path="data.html"><a href="data.html#ordering-and-selecting-the-top-n"><i class="fa fa-check"></i><b>5.3</b> Ordering and selecting the ‘top n’</a></li>
<li class="chapter" data-level="5.4" data-path="data.html"><a href="data.html#summarise"><i class="fa fa-check"></i><b>5.4</b> Summarise</a></li>
<li class="chapter" data-level="5.5" data-path="data.html"><a href="data.html#tidyverse-exercises"><i class="fa fa-check"></i><b>5.5</b> Tidyverse exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="time.html"><a href="time.html"><i class="fa fa-check"></i><b>6</b> Temporal data</a><ul>
<li class="chapter" data-level="6.1" data-path="time.html"><a href="time.html#temporal-analysis-of-crash-data"><i class="fa fa-check"></i><b>6.1</b> Temporal analysis of crash data</a></li>
<li class="chapter" data-level="6.2" data-path="time.html"><a href="time.html#handling-dates-and-date-times"><i class="fa fa-check"></i><b>6.2</b> Handling dates and date-times</a></li>
<li class="chapter" data-level="6.3" data-path="time.html"><a href="time.html#hours-minutes-seconds-with-hms"><i class="fa fa-check"></i><b>6.3</b> Hours, minutes seconds with hms</a></li>
<li class="chapter" data-level="6.4" data-path="time.html"><a href="time.html#the-lubridate-package"><i class="fa fa-check"></i><b>6.4</b> The lubridate package</a></li>
<li class="chapter" data-level="6.5" data-path="time.html"><a href="time.html#dates-in-a-data-frame"><i class="fa fa-check"></i><b>6.5</b> Dates in a data frame</a></li>
<li class="chapter" data-level="6.6" data-path="time.html"><a href="time.html#components-of-time-objects"><i class="fa fa-check"></i><b>6.6</b> Components of time objects</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="space.html"><a href="space.html"><i class="fa fa-check"></i><b>7</b> Spatial data</a><ul>
<li class="chapter" data-level="7.1" data-path="space.html"><a href="space.html#sf-objects"><i class="fa fa-check"></i><b>7.1</b> sf objects</a></li>
<li class="chapter" data-level="7.2" data-path="space.html"><a href="space.html#reading-and-writing-spatial-data"><i class="fa fa-check"></i><b>7.2</b> Reading and writing spatial data</a></li>
<li class="chapter" data-level="7.3" data-path="space.html"><a href="space.html#sf-polygons"><i class="fa fa-check"></i><b>7.3</b> sf polygons</a></li>
<li class="chapter" data-level="7.4" data-path="space.html"><a href="space.html#spatial-subsetting-and-sf-plotting"><i class="fa fa-check"></i><b>7.4</b> Spatial subsetting and sf plotting</a></li>
<li class="chapter" data-level="7.5" data-path="space.html"><a href="space.html#geographic-joins"><i class="fa fa-check"></i><b>7.5</b> Geographic joins</a></li>
<li class="chapter" data-level="7.6" data-path="space.html"><a href="space.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>7.6</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="7.7" data-path="space.html"><a href="space.html#buffers"><i class="fa fa-check"></i><b>7.7</b> Buffers</a></li>
<li class="chapter" data-level="7.8" data-path="space.html"><a href="space.html#attribute-operations-on-sf-objects"><i class="fa fa-check"></i><b>7.8</b> Attribute operations on sf objects</a></li>
<li class="chapter" data-level="7.9" data-path="space.html"><a href="space.html#mapping-road-crash-data"><i class="fa fa-check"></i><b>7.9</b> Mapping road crash data</a></li>
<li class="chapter" data-level="7.10" data-path="space.html"><a href="space.html#analysing-point-data"><i class="fa fa-check"></i><b>7.10</b> Analysing point data</a></li>
<li class="chapter" data-level="7.11" data-path="space.html"><a href="space.html#analysing-crash-data-on-road-networks"><i class="fa fa-check"></i><b>7.11</b> Analysing crash data on road networks</a></li>
<li class="chapter" data-level="" data-path="space.html"><a href="space.html#bonus-exercises"><i class="fa fa-check"></i>Bonus exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="join.html"><a href="join.html"><i class="fa fa-check"></i><b>8</b> Joining road crash tables</a><ul>
<li class="chapter" data-level="8.1" data-path="join.html"><a href="join.html#stats19-tables"><i class="fa fa-check"></i><b>8.1</b> STATS19 tables</a></li>
<li class="chapter" data-level="8.2" data-path="join.html"><a href="join.html#joining-casualty-data"><i class="fa fa-check"></i><b>8.2</b> Joining casualty data</a></li>
<li class="chapter" data-level="8.3" data-path="join.html"><a href="join.html#joining-vehicle-data"><i class="fa fa-check"></i><b>8.3</b> Joining vehicle data</a></li>
<li class="chapter" data-level="8.4" data-path="join.html"><a href="join.html#case-study-london"><i class="fa fa-check"></i><b>8.4</b> Case study: London</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="next-steps.html"><a href="next-steps.html"><i class="fa fa-check"></i><b>9</b> Next steps</a><ul>
<li class="chapter" data-level="9.1" data-path="next-steps.html"><a href="next-steps.html#automated-reporting-with-rmarkdown"><i class="fa fa-check"></i><b>9.1</b> Automated reporting with RMarkdown</a></li>
<li class="chapter" data-level="9.2" data-path="next-steps.html"><a href="next-steps.html#sharing-code"><i class="fa fa-check"></i><b>9.2</b> Sharing code</a></li>
<li class="chapter" data-level="9.3" data-path="next-steps.html"><a href="next-steps.html#asking-questions"><i class="fa fa-check"></i><b>9.3</b> Asking questions</a></li>
<li class="chapter" data-level="9.4" data-path="next-steps.html"><a href="next-steps.html#testimonials"><i class="fa fa-check"></i><b>9.4</b> Testimonials</a><ul>
<li class="chapter" data-level="9.4.1" data-path="next-steps.html"><a href="next-steps.html#r-for-professional-road-safety-analysts"><i class="fa fa-check"></i><b>9.4.1</b> R for professional road safety analysts</a></li>
<li class="chapter" data-level="9.4.2" data-path="next-steps.html"><a href="next-steps.html#r-in-a-road-safety-research-consultancy"><i class="fa fa-check"></i><b>9.4.2</b> R in a road safety research consultancy</a></li>
<li class="chapter" data-level="9.4.3" data-path="next-steps.html"><a href="next-steps.html#using-r-in-a-road-safety-charity"><i class="fa fa-check"></i><b>9.4.3</b> Using R in a road safety charity</a></li>
<li class="chapter" data-level="9.4.4" data-path="next-steps.html"><a href="next-steps.html#using-r-in-other-areas-of-road-safety-research"><i class="fa fa-check"></i><b>9.4.4</b> Using R in other areas of road safety research</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>10</b> References</a></li>
<li class="chapter" data-level="11" data-path="rrsrr.html"><a href="rrsrr.html"><i class="fa fa-check"></i><b>11</b> rrsrr</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reproducible road safety research with R: A practical introduction</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="join" class="section level1">
<h1><span class="header-section-number">8</span> Joining road crash tables</h1>
<div id="stats19-tables" class="section level2">
<h2><span class="header-section-number">8.1</span> STATS19 tables</h2>
<!-- Content on joining road crash tables. -->
<p>Thus far, we have been working primarily with ‘accident’ level data, but there is much useful data in other tables.
As outlined in the <code>stats19</code> vignette — which you can view by entering the command <code>vignette("stats19")</code> to get extended help pages about R packages — there are three main tables that contain STATS19 data.</p>
<p>Let’s read-in data from 2019 to take a look:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="join.html#cb170-1"></a><span class="kw">library</span>(stats19)</span>
<span id="cb170-2"><a href="join.html#cb170-2"></a>ac =<span class="st"> </span><span class="kw">get_stats19</span>(<span class="dt">year =</span> <span class="dv">2019</span>, <span class="dt">type =</span> <span class="st">&quot;accidents&quot;</span>)</span>
<span id="cb170-3"><a href="join.html#cb170-3"></a>ca =<span class="st"> </span><span class="kw">get_stats19</span>(<span class="dt">year =</span> <span class="dv">2019</span>, <span class="dt">type =</span> <span class="st">&quot;casualties&quot;</span>)</span>
<span id="cb170-4"><a href="join.html#cb170-4"></a>ve =<span class="st"> </span><span class="kw">get_stats19</span>(<span class="dt">year =</span> <span class="dv">2019</span>, <span class="dt">type =</span> <span class="st">&quot;vehicles&quot;</span>)</span></code></pre></div>
<p>The three objects read-in above correspond to the main types of entity that are recorded by the police:</p>
<ul>
<li>Crashes: The ‘crash event’ table contains general data about crashes, including where and when they happened and the conditions in which the crash occurred (e.g. light levels in the column <code>light_conditions</code> in the <code>ac</code> object). For historical reasons, crash level data is stored in tables called ‘Accidents’ (a term that has fallen out of favour because it implies that nobody was at fault). See names for all 33 variables in the crashes table by running the command <code>names(ac)</code>. Crashes range from collisions involving only one vehicle and another entity (e.g. a person on foot, bicycle or a car) causing only ‘slight’ injuries such as a graze, to multi-vehicle pile-ups involving multiple deaths and dozens of slight and serious injuries.</li>
<li>Casualties: The casualties table, assigned to an object called <code>ca</code> in the code above, contains data at the casualty level. As you will see by running the command <code>names(ca)</code>, the STATS19 casualties table has 16 variables including <code>age_of_casualty</code>, <code>casualty_severity</code> and <code>casualty_type</code>, reporting the mode of transport in which the person was travelling when they were hit.</li>
<li>Vehicles: The vehicles table, assigned to <code>ve</code> above, contains information about the vehicles and their drivers involved in each collision. As you will see by running the command <code>names(ve)</code>, the 23 variables in this table includes <code>vehicle_type</code>, <code>hit_object_off_carriageway</code> and <code>first_point_of_impact</code>. Information about the driver of vehicles involved is contained in variables such as <code>age_of_driver</code>, <code>engine_capacity_cc</code> and <code>age_of_vehicle</code>.</li>
</ul>
<p>Each table represents the same phenomena: road casualties in Great Britain in 2019.
Therefore, you may expect they would have the same number of rows, but this is not the case:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="join.html#cb171-1"></a><span class="kw">nrow</span>(ac)</span></code></pre></div>
<pre><code>## [1] 117536</code></pre>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="join.html#cb173-1"></a><span class="kw">nrow</span>(ca)</span></code></pre></div>
<pre><code>## [1] 153158</code></pre>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="join.html#cb175-1"></a><span class="kw">nrow</span>(ve)</span></code></pre></div>
<pre><code>## [1] 216381</code></pre>
<p>The reason for this is that there are, on average, more than one casualty per crash (e.g. when a car hits two people), and more than one vehicle, including bicycles, per crash<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>
We can find the average number of casualties and vehicles per crash as follows:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="join.html#cb177-1"></a><span class="kw">nrow</span>(ca) <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(ac)</span></code></pre></div>
<pre><code>## [1] 1.303073</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="join.html#cb179-1"></a><span class="kw">nrow</span>(ve) <span class="op">/</span><span class="st"> </span><span class="kw">nrow</span>(ac)</span></code></pre></div>
<pre><code>## [1] 1.840976</code></pre>
<p>The output of the commands above show that there are around 1.3 casualties and 1.8 vehicles involved in each crash record in the STATS19 dataset for 2019.
Each table contains a different number of columns, reporting the characteristics of each casualty and each driver/vehicle for the <code>ca</code> and <code>ve</code> datasets respectively.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="join.html#cb181-1"></a><span class="kw">ncol</span>(ac)</span></code></pre></div>
<pre><code>## [1] 33</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="join.html#cb183-1"></a><span class="kw">ncol</span>(ca)</span></code></pre></div>
<pre><code>## [1] 16</code></pre>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="join.html#cb185-1"></a><span class="kw">ncol</span>(ve)</span></code></pre></div>
<pre><code>## [1] 23</code></pre>
<p>The output of the previous code chunk shows that we have more variables in the ‘accidents’ table than the others but the others, but the other tables are data rich with 16 columns on the casualties and 23 on the vehicles.
To check that the datasets are consistent, we can check that the number of casualties reported in the crashes table is equal to the number of rows in the casualties table, and the same for the vehicles table:</p>
<!-- ## Auditing the records -->
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="join.html#cb187-1"></a><span class="kw">sum</span>(ac<span class="op">$</span>number_of_casualties) <span class="op">==</span><span class="st"> </span><span class="kw">nrow</span>(ca) </span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="join.html#cb189-1"></a><span class="kw">sum</span>(ac<span class="op">$</span>number_of_vehicles) <span class="op">==</span><span class="st"> </span><span class="kw">nrow</span>(ve)   </span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<!-- Sometimes crash, casualty and vehicle datasets will be inconsistent, for example, after removing records that contain no geographic coordinates with the command `format_sf()`, as demonstrated below: -->
<!-- After the 28 crash records with missing coordinates have been removed, the associated casualty and vehicles datasets do not match. -->
<!-- Update the tables and run some further checks to ensure that records in the accidents table match with those in the now updated other two tables as follows: -->
</div>
<div id="joining-casualty-data" class="section level2">
<h2><span class="header-section-number">8.2</span> Joining casualty data</h2>
<p>To join casualty (or vehicle) data onto the <code>ac</code> object above, the <code>inner_join()</code> function from <code>dplyr</code> can be used as follows:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="join.html#cb191-1"></a>ac_cas_joined =<span class="st"> </span><span class="kw">inner_join</span>(ac, ca)</span></code></pre></div>
<pre><code>## Joining, by = &quot;accident_index&quot;</code></pre>
<p>The above command worked because the two datasets have a shared variable name: <code>accident_index</code>.
Note that the command worked by duplicating accident records for multiple casualties.
We can see this finding the accident that had the most crashes and printing the results in the <code>ac</code> and new joined dataset, as follows:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="join.html#cb193-1"></a>id_with_most_crashes =<span class="st"> </span>ac <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb193-2"><a href="join.html#cb193-2"></a><span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">wt =</span> number_of_casualties) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb193-3"><a href="join.html#cb193-3"></a><span class="st">  </span><span class="kw">pull</span>(accident_index)</span>
<span id="cb193-4"><a href="join.html#cb193-4"></a>id_with_most_crashes</span></code></pre></div>
<pre><code>## [1] &quot;2019500885809&quot;</code></pre>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="join.html#cb195-1"></a>ac <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(accident_index <span class="op">==</span><span class="st"> </span>id_with_most_crashes) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb195-2"><a href="join.html#cb195-2"></a><span class="st">  </span><span class="kw">select</span>(accident_index, accident_severity, number_of_vehicles, number_of_casualties)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 4
##   accident_index accident_severity number_of_vehicles number_of_casualties
##   &lt;chr&gt;          &lt;chr&gt;                          &lt;int&gt;                &lt;int&gt;
## 1 2019500885809  Serious                            1                   52</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="join.html#cb197-1"></a>ac_cas_joined <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(accident_index <span class="op">==</span><span class="st"> </span>id_with_most_crashes) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb197-2"><a href="join.html#cb197-2"></a><span class="st">  </span><span class="kw">select</span>(accident_index, accident_severity, number_of_vehicles, number_of_casualties, casualty_reference)</span></code></pre></div>
<pre><code>## # A tibble: 52 x 5
##    accident_index accident_severi… number_of_vehic… number_of_casua…
##    &lt;chr&gt;          &lt;chr&gt;                       &lt;int&gt;            &lt;int&gt;
##  1 2019500885809  Serious                         1               52
##  2 2019500885809  Serious                         1               52
##  3 2019500885809  Serious                         1               52
##  4 2019500885809  Serious                         1               52
##  5 2019500885809  Serious                         1               52
##  6 2019500885809  Serious                         1               52
##  7 2019500885809  Serious                         1               52
##  8 2019500885809  Serious                         1               52
##  9 2019500885809  Serious                         1               52
## 10 2019500885809  Serious                         1               52
## # … with 42 more rows, and 1 more variable: casualty_reference &lt;int&gt;</code></pre>
</div>
<div id="joining-vehicle-data" class="section level2">
<h2><span class="header-section-number">8.3</span> Joining vehicle data</h2>
<p>The same approach can be used to join vehicle data onto the crash record data:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="join.html#cb199-1"></a>ac_veh_joined =<span class="st"> </span><span class="kw">inner_join</span>(ac, ve)</span></code></pre></div>
<pre><code>## Joining, by = &quot;accident_index&quot;</code></pre>
<p>This information can be used as the basis of who-hit-who visualisation, in this case looking at vehicles involved in the most common type of casualties (recoded using the <code>trafficalmr</code> package):</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="join.html#cb201-1"></a>remotes<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;saferactive/trafficalmr&quot;</span>)</span>
<span id="cb201-2"><a href="join.html#cb201-2"></a><span class="kw">library</span>(trafficalmr)</span>
<span id="cb201-3"><a href="join.html#cb201-3"></a>ac_cas_joined<span class="op">$</span>cas_type =<span class="st"> </span><span class="kw">tc_recode_casualties</span>(ac_cas_joined<span class="op">$</span>casualty_type)</span>
<span id="cb201-4"><a href="join.html#cb201-4"></a>p =<span class="st"> </span><span class="kw">c</span>(<span class="st">`</span><span class="dt">HGV_occupant|Minibus_occupant|Taxi_occupant|Moto*.+</span><span class="st">`</span> =<span class="st"> &quot;Other&quot;</span>)</span>
<span id="cb201-5"><a href="join.html#cb201-5"></a>ac_cas_joined<span class="op">$</span>cas_type =<span class="st"> </span><span class="kw">tc_recode_casualties</span>(ac_cas_joined<span class="op">$</span>cas_type, <span class="dt">pattern =</span> p)</span>
<span id="cb201-6"><a href="join.html#cb201-6"></a><span class="kw">barplot</span>(<span class="kw">table</span>(ac_cas_joined<span class="op">$</span>cas_type))</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-114"></span>
<img src="figures/unnamed-chunk-114-1.png" alt="Barplot of recoded casualty type frequencies" width="672" />
<p class="caption">
Figure 8.1: Barplot of recoded casualty type frequencies
</p>
</div>
<p>To find the largest vehicle involved in each casualty, we can similarly pre-process the vehicle data as follows:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="join.html#cb202-1"></a>p =<span class="st"> </span><span class="kw">c</span>(<span class="st">`</span><span class="dt">Van*.+</span><span class="st">`</span> =<span class="st"> &quot;Van&quot;</span>, <span class="st">`</span><span class="dt">Pedal cycle</span><span class="st">`</span> =<span class="st"> &quot;Bicycle&quot;</span>,</span>
<span id="cb202-2"><a href="join.html#cb202-2"></a>  <span class="st">`</span><span class="dt">(M|m)otorcycle*.+|Elec*.+</span><span class="st">`</span> =<span class="st"> &quot;Motorcycle&quot;</span>,</span>
<span id="cb202-3"><a href="join.html#cb202-3"></a>  <span class="st">`</span><span class="dt">Taxi*|Data*.+|Agri*.+|Ridden*.+|Mobility*.+|Tram*.+|(M|m)otorcycle*.+|Elec*.+</span><span class="st">`</span> =<span class="st"> &quot;Other&quot;</span>,</span>
<span id="cb202-4"><a href="join.html#cb202-4"></a>  <span class="st">`</span><span class="dt">Bus*.+</span><span class="st">`</span> =<span class="st"> &quot;Bus&quot;</span>, <span class="st">`</span><span class="dt">Bus|Minibus*.+|Other*.+</span><span class="st">`</span> =<span class="st"> &quot;Other&quot;</span>, <span class="st">`</span><span class="dt">Goods*.+</span><span class="st">`</span> =<span class="st"> &quot;HGV&quot;</span>)</span>
<span id="cb202-5"><a href="join.html#cb202-5"></a>ac_veh_joined<span class="op">$</span>veh_type =<span class="st"> </span><span class="kw">tc_recode_vehicle_type</span>(ac_veh_joined<span class="op">$</span>vehicle_type, p)</span>
<span id="cb202-6"><a href="join.html#cb202-6"></a><span class="co"># dput(unique(ac_veh_joined$veh_type))</span></span>
<span id="cb202-7"><a href="join.html#cb202-7"></a>l =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Bicycle&quot;</span>, <span class="st">&quot;Car&quot;</span>, <span class="st">&quot;Other&quot;</span>, <span class="st">&quot;Van&quot;</span>, <span class="st">&quot;HGV&quot;</span>)</span>
<span id="cb202-8"><a href="join.html#cb202-8"></a>ac_veh_joined<span class="op">$</span>vehicle =<span class="st"> </span><span class="kw">factor</span>(ac_veh_joined<span class="op">$</span>veh_type, <span class="dt">levels =</span> l, <span class="dt">ordered =</span> <span class="ot">TRUE</span>)</span>
<span id="cb202-9"><a href="join.html#cb202-9"></a><span class="kw">summary</span>(ac_veh_joined<span class="op">$</span>vehicle)</span></code></pre></div>
<pre><code>## Bicycle     Car   Other     Van     HGV 
##   17437  152686   28450   12579    5229</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="join.html#cb204-1"></a>ac_veh_largest =<span class="st"> </span>ac_veh_joined <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb204-2"><a href="join.html#cb204-2"></a><span class="st">  </span><span class="kw">group_by</span>(accident_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb204-3"><a href="join.html#cb204-3"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">largest_vehicle =</span> <span class="kw">max</span>(vehicle))</span></code></pre></div>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="join.html#cb205-1"></a>ac_cas_veh_largest =<span class="st"> </span><span class="kw">inner_join</span>(ac_cas_joined, ac_veh_largest) </span></code></pre></div>
<pre><code>## Joining, by = &quot;accident_index&quot;</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="join.html#cb207-1"></a>cas_veh_table =<span class="st"> </span><span class="kw">table</span>(ac_cas_veh_largest<span class="op">$</span>cas_type, ac_cas_veh_largest<span class="op">$</span>largest_vehicle)</span>
<span id="cb207-2"><a href="join.html#cb207-2"></a>cvt_df =<span class="st"> </span><span class="kw">as.data.frame</span>(cas_veh_table)</span>
<span id="cb207-3"><a href="join.html#cb207-3"></a><span class="kw">ggplot</span>(cvt_df) <span class="op">+</span></span>
<span id="cb207-4"><a href="join.html#cb207-4"></a><span class="st">  </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(Var2, Freq, <span class="dt">fill =</span> Var1), <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span></span>
<span id="cb207-5"><a href="join.html#cb207-5"></a><span class="st">  </span><span class="kw">scale_fill_discrete</span>(<span class="st">&quot;Casualty type&quot;</span>) <span class="op">+</span></span>
<span id="cb207-6"><a href="join.html#cb207-6"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;Largest vehicle involved&quot;</span>) <span class="op">+</span></span>
<span id="cb207-7"><a href="join.html#cb207-7"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;Number of casualties&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:whohit"></span>
<img src="figures/whohit-1.png" alt="'Who hit who' visualisation of number of casualties (y axis) hurt in crashes involving different vehicle types (largest vehicle in each crash on Y axis)." width="672" />
<p class="caption">
Figure 8.2: ‘Who hit who’ visualisation of number of casualties (y axis) hurt in crashes involving different vehicle types (largest vehicle in each crash on Y axis).
</p>
</div>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="join.html#cb208-1"></a>  <span class="co"># geom_bar(aes(`Vehicle type`, `Casualty type`, fill = `N. crashes`), stat = &quot;identity&quot;)  </span></span></code></pre></div>
</div>
<div id="case-study-london" class="section level2">
<h2><span class="header-section-number">8.4</span> Case study: London</h2>
<p>The three main tables we have just read-in can be joined by the <code>accident_index</code> variable and then filtered using other variables. This is demonstrated in the code chunk below, which subsets all casualties that took place in London, and counts the number of casualties by severity for each crash:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="join.html#cb209-1"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb209-2"><a href="join.html#cb209-2"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb209-3"><a href="join.html#cb209-3"></a>ac_sf =<span class="st"> </span><span class="kw">format_sf</span>(ac)</span>
<span id="cb209-4"><a href="join.html#cb209-4"></a><span class="co"># table(ac_sf$police_force)</span></span>
<span id="cb209-5"><a href="join.html#cb209-5"></a>lnd_police =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;City of London&quot;</span>, <span class="st">&quot;Metropolitan Police&quot;</span>)</span>
<span id="cb209-6"><a href="join.html#cb209-6"></a>ac_lnd =<span class="st"> </span>ac_sf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb209-7"><a href="join.html#cb209-7"></a><span class="st">  </span><span class="kw">filter</span>(police_force <span class="op">%in%</span><span class="st"> </span>lnd_police)</span>
<span id="cb209-8"><a href="join.html#cb209-8"></a>ca_lnd =<span class="st"> </span>ca <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb209-9"><a href="join.html#cb209-9"></a><span class="st">  </span><span class="kw">filter</span>(accident_index <span class="op">%in%</span><span class="st"> </span>ac_lnd<span class="op">$</span>accident_index)</span>
<span id="cb209-10"><a href="join.html#cb209-10"></a>cas_types =<span class="st"> </span>ca_lnd <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb209-11"><a href="join.html#cb209-11"></a><span class="st">  </span><span class="kw">select</span>(accident_index, casualty_type) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb209-12"><a href="join.html#cb209-12"></a><span class="st">  </span><span class="kw">group_by</span>(accident_index) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb209-13"><a href="join.html#cb209-13"></a><span class="st">  </span><span class="kw">summarise</span>(</span>
<span id="cb209-14"><a href="join.html#cb209-14"></a>    <span class="dt">Total =</span> <span class="kw">n</span>(),</span>
<span id="cb209-15"><a href="join.html#cb209-15"></a>    <span class="dt">walking =</span> <span class="kw">sum</span>(casualty_type <span class="op">==</span><span class="st"> &quot;Pedestrian&quot;</span>),</span>
<span id="cb209-16"><a href="join.html#cb209-16"></a>    <span class="dt">cycling =</span> <span class="kw">sum</span>(casualty_type <span class="op">==</span><span class="st"> &quot;Cyclist&quot;</span>),</span>
<span id="cb209-17"><a href="join.html#cb209-17"></a>    <span class="dt">passenger =</span> <span class="kw">sum</span>(casualty_type <span class="op">==</span><span class="st"> &quot;Car occupant&quot;</span>)</span>
<span id="cb209-18"><a href="join.html#cb209-18"></a>    ) </span>
<span id="cb209-19"><a href="join.html#cb209-19"></a>cj =<span class="st"> </span><span class="kw">left_join</span>(ac_lnd, cas_types)</span></code></pre></div>
<p>What just happened? We found the subset of casualties that took place in London with reference to the <code>accident_index</code> variable.
Then we used the <strong>dplyr</strong> function, <code>summarise()</code>, to find the number of people who were in a car, cycling, and walking when they were injured.
This new casualty dataset is joined onto the <code>crashes_lnd</code> dataset.
The result is a spatial (<code>sf</code>) data frame of <code>ac</code> in London, with columns counting how many road users of different types were hurt.
The joined data has additional variables:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="join.html#cb210-1"></a>base<span class="op">::</span><span class="kw">setdiff</span>(<span class="kw">names</span>(cj), <span class="kw">names</span>(ac_lnd))</span></code></pre></div>
<pre><code>## [1] &quot;Total&quot;     &quot;walking&quot;   &quot;cycling&quot;   &quot;passenger&quot;</code></pre>
<p>As a simple spatial plot, we can map all crashes that occurred in London in 2017, with the colour related to the total number of people hurt in each crash.
Placing this plot next to a map of London provides context:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="join.html#cb212-1"></a><span class="kw">plot</span>(</span>
<span id="cb212-2"><a href="join.html#cb212-2"></a>  cj[cj<span class="op">$</span>cycling <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;speed_limit&quot;</span>, ],</span>
<span id="cb212-3"><a href="join.html#cb212-3"></a>  <span class="dt">cex =</span> cj<span class="op">$</span>Total[cj<span class="op">$</span>cycling <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] <span class="op">/</span><span class="st"> </span><span class="dv">3</span>,</span>
<span id="cb212-4"><a href="join.html#cb212-4"></a>  <span class="dt">main =</span> <span class="st">&quot;Speed limit (cycling)&quot;</span></span>
<span id="cb212-5"><a href="join.html#cb212-5"></a>  )</span>
<span id="cb212-6"><a href="join.html#cb212-6"></a><span class="kw">plot</span>(</span>
<span id="cb212-7"><a href="join.html#cb212-7"></a>  cj[cj<span class="op">$</span>passenger <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;speed_limit&quot;</span>, ],</span>
<span id="cb212-8"><a href="join.html#cb212-8"></a>  <span class="dt">cex =</span> cj<span class="op">$</span>Total[cj<span class="op">$</span>passenger <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>] <span class="op">/</span><span class="st"> </span><span class="dv">3</span>,</span>
<span id="cb212-9"><a href="join.html#cb212-9"></a>  <span class="dt">main =</span> <span class="st">&quot;Speed limit (passenger)&quot;</span></span>
<span id="cb212-10"><a href="join.html#cb212-10"></a>  )</span></code></pre></div>
<p><img src="figures/unnamed-chunk-117-1.png" width="90%" /><img src="figures/unnamed-chunk-117-2.png" width="90%" /></p>
<p>The spatial distribution of crashes in London clearly relates to the region’s geography.
Car crashes tend to happen on fast roads, including busy dual carriageway roads, displayed in yellow in Figure 8.2 above.
Cycling is as an urban activity, and the most bike crashes can be found in or near the centre of London, which has a comparatively high level of cycling (compared to the low baseline of 3%).
This can be seen by comparing the previous map (Figure 8.1) with an overview of the area, from an academic paper on the social, spatial and temporal distribution of bike crashes <span class="citation">(Lovelace, Roberts, and Kellar 2016)</span>.</p>
<p>In addition to the <code>Total</code> number of people hurt/killed, <code>cj</code> contains a column for each type of casualty (cyclist, car occupant, etc.), and a number corresponding to casualties in crashes involving each type of vehicle.
It also contains the <code>geometry</code> column from <code>ac_sf</code>.
In other words, joins allow the casualties and vehicles tables to be geo-referenced.
We can then explore the spatial distribution of different casualty types.
For example, Figure 8.3 shows the spatial distribution of pedestrians and car passengers hurt in car crashes across London in 2017, via the following code:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="join.html#cb213-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb213-2"><a href="join.html#cb213-2"></a>ac_types =<span class="st"> </span>cj <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb213-3"><a href="join.html#cb213-3"></a><span class="st">  </span><span class="kw">filter</span>(accident_severity <span class="op">!=</span><span class="st"> &quot;Slight&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb213-4"><a href="join.html#cb213-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">case_when</span>(</span>
<span id="cb213-5"><a href="join.html#cb213-5"></a>    walking <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> &quot;Walking&quot;</span>,</span>
<span id="cb213-6"><a href="join.html#cb213-6"></a>    cycling <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> &quot;Cycling&quot;</span>,</span>
<span id="cb213-7"><a href="join.html#cb213-7"></a>    passenger <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">~</span><span class="st"> &quot;Passenger&quot;</span>,</span>
<span id="cb213-8"><a href="join.html#cb213-8"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> &quot;Other&quot;</span></span>
<span id="cb213-9"><a href="join.html#cb213-9"></a>  ))</span>
<span id="cb213-10"><a href="join.html#cb213-10"></a><span class="kw">ggplot</span>(ac_types, <span class="kw">aes</span>(<span class="dt">size =</span> Total, <span class="dt">colour =</span> speed_limit)) <span class="op">+</span></span>
<span id="cb213-11"><a href="join.html#cb213-11"></a><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">show.legend =</span> <span class="st">&quot;point&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></span>
<span id="cb213-12"><a href="join.html#cb213-12"></a><span class="st">  </span><span class="kw">facet_grid</span>(<span class="kw">vars</span>(type), <span class="kw">vars</span>(accident_severity)) <span class="op">+</span></span>
<span id="cb213-13"><a href="join.html#cb213-13"></a><span class="st">  </span><span class="kw">scale_size</span>(</span>
<span id="cb213-14"><a href="join.html#cb213-14"></a>    <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">12</span>),</span>
<span id="cb213-15"><a href="join.html#cb213-15"></a>    <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="st">&quot;3+&quot;</span>, <span class="dv">12</span>)</span>
<span id="cb213-16"><a href="join.html#cb213-16"></a>    ) <span class="op">+</span></span>
<span id="cb213-17"><a href="join.html#cb213-17"></a><span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;red&quot;</span>)) <span class="op">+</span></span>
<span id="cb213-18"><a href="join.html#cb213-18"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text =</span> <span class="kw">element_blank</span>(), <span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<div class="figure"><span id="fig:sfplot"></span>
<img src="figures/sfplot-1.png" alt="Spatial distribution of serious and fatal crashes in London, for cycling, walking, being a car passenger and other modes of travel. Colour is related to the speed limit where the crash happened (red is faster) and size is proportional to the total number of people hurt in each crash (legend not shown)." width="100%" />
<p class="caption">
Figure 8.3: Spatial distribution of serious and fatal crashes in London, for cycling, walking, being a car passenger and other modes of travel. Colour is related to the speed limit where the crash happened (red is faster) and size is proportional to the total number of people hurt in each crash (legend not shown).
</p>
</div>
<p><strong>Exercises:</strong></p>
<ol style="list-style-type: decimal">
<li>There is a lot going on in the code in this chapter, the most advanced of the guide.
With reference to online help, work through the code line-by-line and look-up
any aspects of the code that you do not fully understand to help figure out what is going on.</li>
<li>Reproduce the final figures for a different city of your choice (not London).</li>
<li><strong>Bonus:</strong> Create more attractive interactive maps to show the spatial distribution of different casualty types in the city of your choice.</li>
</ol>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="18">
<li id="fn18"><p>
STATS19 data contains information on when a single vehicle crashes without involvement of any other vehicles, but not when a lone cyclist crashes without any other vehicle involved.<a href="join.html#fnref18" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="space.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="next-steps.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ITSLeeds/rrsrr/edit/master/08-join.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/ITSLeeds/rrsrr/blob/master/08-join.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
